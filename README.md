# SnearlBot

Telegram-бот для сохранения и отправки голосовых сообщений и стикеров-цитат, а также запрета репостов из заблокированных чатов.

## Зависимости:
`Python 3.10+`

`python-telegram-bot[job-queue] == 20.2`

`Pillow == 9.4.0` - опционально

`pilmoji == 2.0.2` - опционально

`emoji == 1.7.0` - зависимость pilmoji


## Использование
1. Установите Python 3.10+
2. Установите зависимости: `pip install -r requirements.txt`
3. В файл `data/token.txt` запишите свой токен бота.
4. Запустить бота можно с помощью `start_bot.py` или командой `python3 -m snearl`.

### Команды
_(В формате для /setcommands BotFather)_
```
help - Помощь с ботом
info - Информация о чате
block - Внести канал в чёрный список
allow - Разблокировать канал
blacklist - Посмотреть чёрный список
v - Добавить войс
voice_delete - Удалить войс
voicelist - Посмотреть список войсов
q - Добавить цитату
quote_delete - Удалить цитату
quote_random - Шанс рандомной цитаты
quotelist - Посмотреть список цитат
```
### /help
SnearlBot умеет:

---
Удалять репосты из заблокированных чатов
* Заблокировать чат: `/block`;
* Разблокировать чат: `/allow <НомерЧата>`;
* Список блокировок: `/blacklist`;
Заблокировать можно репосты из каналов, чатов и от пользователей.

---
Сохранять и отправлять голосовые сообщения
* Добавить войс:
  1. Ответить на сообщение командой `/v`;
  2. Или `/v [a=НомерАвтора] [Описание]`;
  3. Необязательным параметром `a` можно присвоить войс другому автору, помимо отправителя, `НомерАвтора` можно узнать в списке войсов перед именем автора на кнопке;
* Открыть инлайн список войсов:
  1. `@SnearlBot в [ТекстЗапроса]`;
  2. Запросом может быть имя автора или строка из описания;
* Удалить войс:
  1. `/voice_delete <НомерАвтора> <НомерВойса>`;
* Список войсов: `/voicelist`;

---
Создавать и отправлять стикеры-цитаты
* Добавить цитату:
  1. Ответить на сообщение командой `/q`;
  2. Переслать несколько сообщений, одновременно введя в поле сообщения `/q`;
  3. Опционально можно указать своё описание: `/q [Описание]`;
* Открыть инлайн список цитат:
  1. `@SnearlBot ц [ТекстЗапроса]`;
  2. Запросом может быть имя автора или строка из описания;
* Удалить цитату:
  1. `/quote_delete <НомерАвтора> <НомерЦитаты>`;
* Список цитат: /quotelist;
* Частота случайных цитат: /quote\_random;
  1. От `0`% до `100`%. Вероятность, что бот ответит на сообщение в чате случайной цитатой;

[Примеры создаваемых цитат.](data/import/quotelist/YourChatIdHere/)

## Администрирование
Модуль `start_admin_tool.py` содержит некоторые команды недоступные через бота: функции импорта/экспорта/удаления данных из базы данных, а также функцию миграции данных между чатами-владельцами и функцию локального режима. Инструкции для каждой можно прочитать при её запуске. Для прочих своих запросов редактируйте `data/database.db` через СУБД Sqlite.

### Импорт/экспорт
Импорт производится из директории `data/import`.
Экспорт производится в директорию `data/export`.
Структуры этих двух папок одинаковы:

`blacklist.csv` - список заблокированных чатов и пользователей.

`voicelist/` - иерархия аудио-файлов. Используется в импорте если у вас уже имеются сторонние файлы .ogg.

`quotelist/` - иерархия стикеров. Используется в импорте если у вас уже имеются сторонние файлы .webp.

### База данных и миграция чата
* Войсы и цитаты хранятся привязанными к каждому отдельному чату. Администратор может сменить эту привязку на другой чат вручную.
* При смене типа чата на супергруппу привязка в базе данных меняется автоматически.
* ~~Все данные чата удаляются если бот выходит из него.~~ По умолчанию выключено.

### Локальный режим
В этом режиме бот разрешает использовать команды изменяющие базу данных только администраторам и владельцам одного избранного чата.
С выключенным режимом в любом другом чате пользователи смогут создать собственный набор войсов и список блокировок.

## Как добавить новый функциональный модуль
Файлы модуля хранятся в `snearl/module/`. Там же можно посмотреть на примере как модули реализованы.
Помимо этого нужно:
1. Импортировать новый модуль в `snearl/instance.py` в `start_bot()`;
2. Если модуль использует БД, то добавить нужные вызовы функций в `module/dataupdate.py` в `chat_migrate()` и `bot_status_changed()`;
2. Если модуль использует инлайн, то добавить по аналогии в `module/inline_handler.py`;

Администраторские функции обычно выносятся в отдельный файл и:
1. Импортируются в файле `start_admin_tool.py`;
2. В массив `commands` добавляются доступные пользователю команды;
2. В `clear_table()` добавляется возможность удалить все записи из таблицы БД модуля;
